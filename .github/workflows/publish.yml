name: Publish to pub.dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter pub get
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Decide whether to publish
        id: publish_decision
        shell: bash
        run: |
          set -euo pipefail

          PKG_NAME=$(grep -E '^name:\s*' pubspec.yaml | head -n1 | cut -d ':' -f2- | xargs)
          PKG_VERSION=$(grep -E '^version:\s*' pubspec.yaml | head -n1 | cut -d ':' -f2- | xargs)

          if [[ -z "$PKG_NAME" || -z "$PKG_VERSION" ]]; then
            echo "Could not read name/version from pubspec.yaml" >&2
            exit 1
          fi

          echo "package=$PKG_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$PKG_VERSION" >> "$GITHUB_OUTPUT"

          # Only publish when pubspec.yaml changed in this main push (usually a PR merge).
          # For manual runs (workflow_dispatch), we allow publish to proceed.
          if [[ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]]; then
            BEFORE_SHA='${{ github.event.before }}'
            AFTER_SHA='${{ github.sha }}'

            if [[ -n "$BEFORE_SHA" && "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]]; then
              if git diff --name-only "$BEFORE_SHA" "$AFTER_SHA" -- pubspec.yaml | grep -q 'pubspec.yaml'; then
                echo "pubspec_changed=true" >> "$GITHUB_OUTPUT"
              else
                echo "pubspec_changed=false" >> "$GITHUB_OUTPUT"
                echo "No pubspec.yaml change detected; skipping publish."
                echo "already_published=unknown" >> "$GITHUB_OUTPUT"
                echo "should_publish=false" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            else
              # If we cannot diff (first push), fall back to publishing decision based on version check.
              echo "pubspec_changed=unknown" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "pubspec_changed=manual" >> "$GITHUB_OUTPUT"
          fi

          if curl -fsSL "https://pub.dev/api/packages/${PKG_NAME}" | grep -q "\"version\":\"${PKG_VERSION}\""; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            echo "${PKG_NAME} ${PKG_VERSION} is already on pub.dev; skipping publish."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
            echo "${PKG_NAME} ${PKG_VERSION} not found on pub.dev; will publish."
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure pub.dev auth
        if: steps.publish_decision.outputs.should_publish == 'true'
        id: pub_auth
        shell: bash
        env:
          PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
          PUB_TOKEN: ${{ secrets.PUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -n "${PUB_CREDENTIALS:-}" ]]; then
            mkdir -p "$HOME/.config/dart"
            printf '%s' "$PUB_CREDENTIALS" > "$HOME/.config/dart/pub-credentials.json"
            chmod 600 "$HOME/.config/dart/pub-credentials.json"
            echo "configured=true" >> "$GITHUB_OUTPUT"
            echo "Configured pub.dev auth via PUB_CREDENTIALS."
            exit 0
          fi

          if [[ -n "${PUB_TOKEN:-}" ]]; then
            dart pub token add https://pub.dev --env-var PUB_TOKEN
            echo "configured=true" >> "$GITHUB_OUTPUT"
            echo "Configured pub.dev auth via PUB_TOKEN."
            exit 0
          fi

          echo "configured=false" >> "$GITHUB_OUTPUT"
          echo "Missing PUB_CREDENTIALS or PUB_TOKEN secret. Skipping publish." >&2

      - name: Publish
        if: steps.publish_decision.outputs.should_publish == 'true' && steps.pub_auth.outputs.configured == 'true'
        run: dart pub publish --force
